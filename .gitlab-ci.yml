include:
  - project: infradev/gitlab-ci
    ref: master
    file: /templates/variables.yml

  - project: infradev/gitlab-ci
    ref: master
    file: /templates/codecov.yml

  - project: infradev/gitlab-ci
    ref: master
    file: /jobs/pypi.yml

  - project: infradev/gitlab-ci
    ref: master
    file: /templates/itzik_setup.yml

stages:
  - test
  - deploy
  - post

.install-and-lint:
  tags:
    - infradev
    - ubuntu
  except:
    - /^customer-.*$/
  before_script:
    - !reference [.itzik, before_script]
    - make check_format
    - make lint

py36:
  extends: .install-and-lint
  image: $PYTHON_IMAGE:3.6
  script:
    - pytest

py37:
  extends: .install-and-lint
  image: $PYTHON_IMAGE:3.7
  script:
    - pytest

py38:
  extends: .install-and-lint
  image: $PYTHON_IMAGE:3.8
  script:
    - pytest

py39-codecov:
  extends:
    - .install-and-lint
    - .codecov
  image: $PYTHON_IMAGE:3.9

py310:
  extends: .install-and-lint
  image: $PYTHON_IMAGE:3.10
  script:
    - pytest

docs:
  extends: .install-and-lint
  image: $PYTHON_IMAGE:3.7
  script:
    - pip install -e ".[doc]"
    - sphinx-build -a -W -E doc build/sphinx/html

trigger:
  image: $PYTHON_IMAGE:3.8
  tags:
    - infradev
    - ubuntu
  stage: post
  only:
    - master
    - /^(dev|stable)-\d+(\.\d+)*$/
  script:
    - curl --request POST --form "token=$CI_JOB_TOKEN" --form "ref=$CI_COMMIT_REF_NAME" https://git.infinidat.com/api/v4/projects/222/trigger/pipeline
