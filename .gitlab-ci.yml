include:
  - project: infradev/gitlab-ci
    ref: master
    file: /templates/variables.yml

  - project: infradev/gitlab-ci
    ref: master
    file: /templates/codecov.yml

  - project: infradev/gitlab-ci
    ref: master
    file: /jobs/pypi.yml

  - project: infradev/gitlab-ci
    ref: master
    file: /templates/itzik_setup.yml

variables:
  BUNDLE_NAME: new-infra
  BUNDLE_VERSION: master
  RUN_ITZIK_PARAMETERS: --no-dev --src $INSTALL_DIR --bundle $BUNDLE_NAME --bundle-version $BUNDLE_VERSION --until $CI_PROJECT_NAME -p $CI_PROJECT_DIR[testing] --curr-branch $CI_COMMIT_REF_NAME

stages:
  - test
  - deploy
  - post
  - release

.install-and-lint:
  stage: test
  tags:
    - infradev
    - ubuntu
  except:
    - /^customer-.*$/
    - external
  before_script:
    - !reference [.itzik, before_script]
    - make check_format
    - make lint

py36:
  extends: .install-and-lint
  image: $PYTHON_IMAGE:3.6
  script:
    - pytest

py37:
  extends: .install-and-lint
  image: $PYTHON_IMAGE:3.7
  script:
    - pytest

py38:
  extends: .install-and-lint
  image: $PYTHON_IMAGE:3.8
  script:
    - pytest

py39-codecov:
  extends:
    - .install-and-lint
    - .codecov
  image: $PYTHON_IMAGE:3.9

py310:
  extends: .install-and-lint
  image: $PYTHON_IMAGE:3.10
  script:
    - pytest

docs:
  extends: .install-and-lint
  image: $PYTHON_IMAGE:3.7
  script:
    - pip install -e ".[doc]"
    - sphinx-build -a -W -E doc build/sphinx/html

trigger:
  image: $PYTHON_IMAGE:3.8
  tags:
    - infradev
    - ubuntu
  stage: post
  only:
    - master
    - /^(dev|stable)-\d+(\.\d+)*$/
  script:
    - curl --request POST --form "token=$CI_JOB_TOKEN" --form "ref=$CI_COMMIT_REF_NAME" https://git.infinidat.com/api/v4/projects/222/trigger/pipeline

sanity-tests:
  image: $PYTHON_IMAGE:3.9
  variables:
    BUNDLE_NAME: infradev
    BUNDLE_VERSION: master
    RUN_ITZIK_PARAMETERS: --no-dev --src $INSTALL_DIR --bundle $BUNDLE_NAME --bundle-version $BUNDLE_VERSION
  stage: test
  before_script:
    - !reference [.itzik, before_script]
  script:
    - cd $INSTALL_DIR/infinibox_tests
    - mkdir -p ~/.slash
    - mkdir -p ~/.infinidat
    - echo $INFINILAB_TOKEN > ~/.infinidat/infinilab.tkn
    - cat $SLASH_RC_FILE > ~/.slash/slashrc
    - slash run -S -f suites/integration/dev_sanity.suite --session-label infra-compatibility
  only:
    refs:
      - merge_requests
    variables:
      - $CI_MERGE_REQUEST_TARGET_BRANCH_NAME == "external"

test-release:
  image: $PYTHON_IMAGE:3.9
  stage: test
  script:
    - python -m pip install --upgrade pip
    - pip install setuptools wheel twine
    - python setup.py sdist bdist_wheel
    - twine upload -u "__token__" -p $TEST_PYPI_API_TOKEN --verbose --non-interactive --repository-url https://test.pypi.org/legacy/ dist/*
    - python -m pip install --pre --index-url https://test.pypi.org/simple/ --extra-index-url https://pypi.org/simple infinisdk
    - python -c "import infinisdk"
  only:
    refs:
      - merge_requests
    variables:
      - $CI_MERGE_REQUEST_TARGET_BRANCH_NAME == "external"

test-package-py36:
  image: $PYTHON_IMAGE:3.6
  stage: test
  script:
    - python -m pip install --upgrade pip
    - pip install -e .
    - pip install click~=8.0.4 black~=21.8b0 isort~=5.0.9 "pylint>=2"
    - make check_format
    - make lint
  only:
    refs:
      - merge_requests
    variables:
      - $CI_MERGE_REQUEST_TARGET_BRANCH_NAME == "external"

test-package-py37:
  image: $PYTHON_IMAGE:3.7
  stage: test
  script:
    - python -m pip install --upgrade pip
    - pip install -e .
    - pip install click~=8.0.4 black~=21.8b0 isort~=5.0.9 "pylint>=2"
    - make check_format
    - make lint
  only:
    refs:
      - merge_requests
    variables:
      - $CI_MERGE_REQUEST_TARGET_BRANCH_NAME == "external"

test-package-py38:
  image: $PYTHON_IMAGE:3.8
  stage: test
  script:
    - python -m pip install --upgrade pip
    - pip install -e .
    - pip install click~=8.0.4 black~=21.8b0 isort~=5.0.9 "pylint>=2"
    - make check_format
    - make lint
  only:
    refs:
      - merge_requests
    variables:
      - $CI_MERGE_REQUEST_TARGET_BRANCH_NAME == "external"

test-package-py39:
  image: $PYTHON_IMAGE:3.9
  stage: test
  script:
    - python -m pip install --upgrade pip
    - pip install -e .
    - pip install click~=8.0.4 black~=21.8b0 isort~=5.0.9 "pylint>=2"
    - make check_format
    - make lint
  only:
    refs:
      - merge_requests
    variables:
      - $CI_MERGE_REQUEST_TARGET_BRANCH_NAME == "external"

test-package-py310:
  image: $PYTHON_IMAGE:3.10
  stage: test
  script:
    - python -m pip install --upgrade pip
    - pip install -e .
    - pip install click~=8.0.4 black~=21.8b0 isort~=5.0.9 "pylint>=2"
    - make check_format
    - make lint
  only:
    refs:
      - merge_requests
    variables:
      - $CI_MERGE_REQUEST_TARGET_BRANCH_NAME == "external"

push-to-github:
  # Refer to https://wiki.infinidat.com/display/ID/InfiniSDK+New+Release+Strategy#InfiniSDKNewReleaseStrategy-new_flow
  image: $PYTHON_IMAGE:3.9
  variables:
    BUNDLE_NAME: infradev
    BUNDLE_VERSION: master
    RUN_ITZIK_PARAMETERS: --no-dev --src $INSTALL_DIR --bundle $BUNDLE_NAME --bundle-version $BUNDLE_VERSION --curr-branch $CI_COMMIT_REF_NAME
  stage: release
  when: manual
  before_script:
    - !reference [.itzik, before_script]
  script:
    - infradev customer-sdk push-external-to-github --email $INFINISDK_RELEASE_EMAIL --auth-token $INFINISDK_RELEASE_TOKEN --gitlab-repo $INFINISDK_GITLAB_REPO --github-repo $INFINISDK_GITHUB_REPO --github-username $INFINISDK_RELEASE_USER --version $RELEASE_VERSION --non-version-update $NON_VERSIONED_UPDATE
  only:
    - external
