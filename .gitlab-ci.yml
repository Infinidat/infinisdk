variables:
  BUNDLE_VERSION: master
  INSTALL_DIR: /root/src
  RUN_ITZIK: https://git.infinidat.com/infradev/helpers/raw/master/run_itzik.py
  RUN_ITZIK_PARAMETERS: --no-dev --src $INSTALL_DIR --bundle new-infra --bundle-version $BUNDLE_VERSION --until $CI_PROJECT_NAME -p $CI_PROJECT_DIR[testing] --curr-branch $CI_COMMIT_REF_NAME
  PYTHON_IMAGE: git.infinidat.com:4567/infradev/infi-docker/python

stages:
  - test
  - deploy
  - post

.test:
  tags:
    - infradev
    - ubuntu
  except:
    - /^customer-.*$/
  script:
    - curl -sL $RUN_ITZIK | python - $RUN_ITZIK_PARAMETERS
    - source $INSTALL_DIR/env/bin/activate
    - pylint --rcfile .pylintrc -j $(nproc) infinisdk scripts tests doc/*.doctest_context
    - pytest -ra -W error::DeprecationWarning

py35:
  extends: .test
  image: $PYTHON_IMAGE:3.5

py36:
  extends: .test
  image: $PYTHON_IMAGE:3.6

py37:
  extends: .test
  image: $PYTHON_IMAGE:3.7

py38:
  extends: .test
  image: $PYTHON_IMAGE:3.8

docs:
  extends: .test
  image: $PYTHON_IMAGE:3.7
  script:
    - pip install -e ".[doc]"
    - sphinx-build -a -W -E doc build/sphinx/html

pypi:
  image: $PYTHON_IMAGE:3.8
  tags:
    - infradev
    - ubuntu
  stage: deploy
  only:
    - master
    - tags
    - /^(dev|stable)-\d+(\.\d+)*$/
  script:
    - curl -sL http://goto/pypi_register | python - -v ./

trigger:
  image: $PYTHON_IMAGE:3.8
  tags:
    - infradev
    - ubuntu
  stage: post
  only:
    - master
    - /^(dev|stable)-\d+(\.\d+)*$/
  script:
    - curl --request POST --form "token=$CI_JOB_TOKEN" --form "ref=$CI_COMMIT_REF_NAME" https://git.infinidat.com/api/v4/projects/222/trigger/pipeline
