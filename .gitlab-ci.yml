include:
  - project: infradev/gitlab-ci
    ref: master
    file: /templates/variables.yml

  - project: infradev/gitlab-ci
    ref: master
    file: /templates/codecov.yml

stages:
  - test
  - deploy
  - post

.install-and-lint:
  tags:
    - infradev
    - ubuntu
  except:
    - /^customer-.*$/
  before_script:
    - curl -sL $RUN_ITZIK | python - $RUN_ITZIK_PARAMETERS
    - source $INSTALL_DIR/env/bin/activate
    - pylint --rcfile .pylintrc -j $(nproc) infinisdk scripts tests doc/*.doctest_context

py36:
  extends: .install-and-lint
  image: $PYTHON_IMAGE:3.6
  script:
    - pytest

py37:
  extends: .install-and-lint
  image: $PYTHON_IMAGE:3.7
  script:
    - pytest

py38:
  extends: .install-and-lint
  image: $PYTHON_IMAGE:3.8
  script:
    - pytest


py39-codecov:
  extends: 
    - .install-and-lint
    - .codecov
  image: $PYTHON_IMAGE:3.9

docs:
  extends: .install-and-lint
  image: $PYTHON_IMAGE:3.7
  script:
    - pip install -e ".[doc]"
    - sphinx-build -a -W -E doc build/sphinx/html

pypi:
  image: $PYTHON_IMAGE:3.8
  tags:
    - infradev
    - ubuntu
  stage: deploy
  only:
    - master
    - tags
    - /^(dev|stable)-\d+(\.\d+)*$/
  script:
    - curl -sL http://goto/pypi_register | python - -v ./

trigger:
  image: $PYTHON_IMAGE:3.8
  tags:
    - infradev
    - ubuntu
  stage: post
  only:
    - master
    - /^(dev|stable)-\d+(\.\d+)*$/
  script:
    - curl --request POST --form "token=$CI_JOB_TOKEN" --form "ref=$CI_COMMIT_REF_NAME" https://git.infinidat.com/api/v4/projects/222/trigger/pipeline

