variables:
  BUNDLE_VERSION: stable-5.0.0
  INSTALL_DIR: /root/src
  RUN_ITZIK: https://git.infinidat.com/infradev/helpers/raw/master/run_itzik.py
  RUN_ITZIK_PARAMETERS: --no-dev --src $INSTALL_DIR --bundle new-infra --bundle-version $BUNDLE_VERSION --until infinisdk -p $CI_PROJECT_DIR[testing] --curr-branch $CI_COMMIT_REF_NAME
stages:
  - test
  - deploy
  - post

py27:
  image: python:2.7
  tags:
    - infradev
  except:
    - /^customer-.*$/
  script:
    - curl -sL $RUN_ITZIK | python2.7 - $RUN_ITZIK_PARAMETERS
    - source $INSTALL_DIR/env/bin/activate
    - pylint --rcfile .pylintrc -j $(nproc) infinisdk scripts tests
    - pytest -ra -W error::DeprecationWarning

py35:
  image: python:3.5
  tags:
    - infradev
  except:
    - /^customer-.*$/
  script:
    - curl -sL $RUN_ITZIK | python3.5 - $RUN_ITZIK_PARAMETERS
    - source $INSTALL_DIR/env/bin/activate
    - pylint --rcfile .pylintrc -j $(nproc) infinisdk scripts tests
    - pytest -ra -W error::DeprecationWarning

py36:
  image: python:3.6
  tags:
    - infradev
  except:
    - /^customer-.*$/
  script:
    - curl -sL $RUN_ITZIK | python3.6 - $RUN_ITZIK_PARAMETERS
    - source $INSTALL_DIR/env/bin/activate
    - pylint --rcfile .pylintrc -j $(nproc) infinisdk scripts tests
    - pytest -ra -W error::DeprecationWarning

py37:
  image: python:3.7
  tags:
    - infradev
  except:
    - /^customer-.*$/
  script:
    - curl -sL $RUN_ITZIK | python3.7 - $RUN_ITZIK_PARAMETERS
    - source $INSTALL_DIR/env/bin/activate
    - pylint --rcfile .pylintrc -j $(nproc) infinisdk scripts tests
    - pytest -ra -W error::DeprecationWarning

pypi:
  image: python
  tags:
    - infradev
  stage: deploy
  only:
    - master
    - tags
    - /^(dev|stable)-\d+(\.\d+)*$/
  script:
    - curl -sL http://goto/pypi_register | python - -v ./

trigger:
  image: python
  tags:
    - infradev
  stage: post
  only:
    - master
    - /^(dev|stable)-\d+(\.\d+)*$/
  script:
    - curl --request POST --form "token=$CI_JOB_TOKEN" --form "ref=$CI_COMMIT_REF_NAME" https://git.infinidat.com/api/v4/projects/222/trigger/pipeline
