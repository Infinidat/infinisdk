include:
  - project: infradev/gitlab-ci
    ref: master
    file: /templates/variables.yml

  - project: infradev/gitlab-ci
    ref: master
    file: /templates/codecov.yml

  - project: infradev/gitlab-ci
    ref: master
    file: /jobs/pypi.yml

  - project: infradev/gitlab-ci
    ref: master
    file: /templates/itzik_setup.yml

stages:
  - test
  - release

sanity-tests:
  image: $PYTHON_IMAGE:3.9
  variables:
    BUNDLE_NAME: infradev
    BUNDLE_VERSION: master
    RUN_ITZIK_PARAMETERS: --no-dev --src $INSTALL_DIR --bundle $BUNDLE_NAME --bundle-version $BUNDLE_VERSION
  stage: test
  before_script:
    - !reference [.itzik, before_script]
  script:
    - cd $INSTALL_DIR/infinibox_tests
    - mkdir -p ~/.slash
    - mkdir -p ~/.infinidat
    - echo $INFINILAB_TOKEN > ~/.infinidat/infinilab.tkn
    - cat $SLASH_RC_FILE > ~/.slash/slashrc
    - slash run -S -f suites/integration/dev_sanity.suite --session-label infra-compatibility
  only:
    refs:
      - merge_requests
    variables:
      - $CI_MERGE_REQUEST_TARGET_BRANCH_NAME == "external"

test-release:
  image: $PYTHON_IMAGE:3.9
  stage: test
  script:
    - python -m pip install --upgrade pip
    - pip install setuptools wheel twine
    - python setup.py sdist bdist_wheel
    - twine upload -u $TEST_PYPI_USER -p $TEST_PYPI_PASSWORD --verbose --non-interactive --repository-url https://test.pypi.org/legacy/ dist/*
    - python -m pip install --index-url https://test.pypi.org/simple/ --extra-index-url https://pypi.org/simple infinisdk
    - python -c "import infinisdk"
  only:
    refs:
      - merge_requests
    variables:
      - $CI_MERGE_REQUEST_TARGET_BRANCH_NAME == "external"

push-to-github:
  # Refer to https://wiki.infinidat.com/display/ID/InfiniSDK+New+Release+Strategy#InfiniSDKNewReleaseStrategy-new_flow
  image: $PYTHON_IMAGE:3.9
  variables:
    BUNDLE_NAME: infradev
    BUNDLE_VERSION: master
    RUN_ITZIK_PARAMETERS: --no-dev --src $INSTALL_DIR --bundle $BUNDLE_NAME --bundle-version $BUNDLE_VERSION --curr-branch $CI_COMMIT_REF_NAME
  stage: release
  when: manual
  before_script:
    - !reference [.itzik, before_script]
  script:
    - infradev customer-sdk push-external-to-github --email $INFINISDK_RELEASE_EMAIL --auth-token $INFINISDK_RELEASE_TOKEN --gitlab-repo $INFINISDK_GITLAB_REPO --github-repo $INFINISDK_GITHUB_REPO --github-username $INFINISDK_RELEASE_USER --version $RELEASE_VERSION
  only:
    - external
